{% extends 'calificaciones/base.html' %}

{% load tz %}
{% block title %}Mi Perfil - NUAM{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üë§ Mi Perfil</h4>
            </div>
            <div class="card-body" style="background-color: #1a1a1a; color: #ffffff !important;">

                <!-- Informaci√≥n Personal -->
                <div class="row mb-5">
                    <div class="col-md-8">
                        <h5 class="mb-4"
                            style="color: #ff4201; border-bottom: 2px solid #ff4201; padding-bottom: 10px;">
                            üìù Informaci√≥n Personal
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="profile-info-item">
                                    <strong style="color: #ff4201; display: block; margin-bottom: 5px;">Nombre
                                        Completo</strong>
                                    <span style="color: #ffffff !important; font-size: 1.1rem;">{{ user.nombre }}</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="profile-info-item">
                                    <strong style="color: #ff4201; display: block; margin-bottom: 5px;">Correo
                                        Electr√≥nico</strong>
                                    <span style="color: #ffffff !important; font-size: 1.1rem;">{{ user.correo }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="profile-info-item">
                                    <strong style="color: #ff4201; display: block; margin-bottom: 5px;">Rol</strong>
                                    <span class="badge bg-info" style="color: #000000 !important; font-size: 0.9rem;">
                                        {{ user.rol }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="profile-info-item">
                                    <strong style="color: #ff4201; display: block; margin-bottom: 5px;">Estado</strong>
                                    <span class="badge bg-{% if user.estado %}success{% else %}danger{% endif %}"
                                        style="color: #ffffff !important; font-size: 0.9rem;">
                                        {{ user.estado|yesno:"Activo,Inactivo" }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="profile-info-item">
                                    <strong style="color: #ff4201; display: block; margin-bottom: 5px;">Fecha de
                                        Creaci√≥n</strong>
                                    {% localtime on %}
                                    <span style="color: #cccccc !important;">{{ user.fecha_creacion|date:"d/m/Y H:i" }}</span>
                                    {% endlocaltime %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="profile-avatar mb-3">
                                <div
                                    style="width: 120px; height: 120px; background: linear-gradient(135deg, #ff4201, #ff6b35); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 4px solid #333;">
                                    <span style="color: #000000; font-size: 2.5rem; font-weight: bold;">
                                        {{ user.nombre|first|upper }}
                                    </span>
                                </div>
                            </div>
                            <h6 style="color: #ff4201;">{{ user.rol }}</h6>
                            {% localtime on %}
                            <p style="color: #cccccc; font-size: 0.9rem;">Miembro desde {{ user.fecha_creacion|date:"F Y" }}</p>
                            {% endlocaltime %}
                        </div>
                    </div>
                </div>

                <!-- Separador -->
                <div class="row mb-4">
                    <div class="col-12">
                        <hr style="border-color: #444; margin: 30px 0;">
                    </div>
                </div>

                <!-- Cambio de Contrase√±a -->
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="mb-4"
                            style="color: #ff4201; border-bottom: 2px solid #ff4201; padding-bottom: 10px;">
                            üîí Cambiar Contrase√±a
                        </h5>

                        <form method="post">
                            {% csrf_token %}

                            {% if form.errors %}
                            <div class="alert alert-danger mb-4">
                                <strong>Error:</strong> Por favor corrige los siguientes errores:
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            <div class="row mb-4">
                                <div class="col-12">
                                    <hr style="border-color: #444; margin: 30px 0;">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_old_password" class="form-label"
                                            style="color: #ffffff !important;">
                                            Contrase√±a Actual
                                        </label>
                                        <input type="password" name="old_password" id="id_old_password"
                                            class="form-control password-field"
                                            placeholder="Ingresa tu contrase√±a actual" required
                                            style="color: #ffffff; background-color: #2a2a2a; border: 1px solid #444;">
                                    </div>

                                    <div class="mb-3">
                                        <label for="id_new_password1" class="form-label"
                                            style="color: #ffffff !important;">
                                            Nueva Contrase√±a
                                        </label>
                                        <input type="password" name="new_password1" id="id_new_password1"
                                            class="form-control password-field" placeholder="Ingresa nueva contrase√±a"
                                            required
                                            style="color: #ffffff; background-color: #2a2a2a; border: 1px solid #444;">
                                    </div>

                                    <div class="mb-4">
                                        <label for="id_new_password2" class="form-label"
                                            style="color: #ffffff !important;">
                                            Confirmar Nueva Contrase√±a
                                        </label>
                                        <input type="password" name="new_password2" id="id_new_password2"
                                            class="form-control password-field" placeholder="Confirma nueva contrase√±a"
                                            required
                                            style="color: #ffffff; background-color: #2a2a2a; border: 1px solid #444;">
                                    </div>

                                    <div class="d-flex gap-3 mb-4">
                                        <button type="submit" id="change-password-submit" class="btn btn-primary" disabled>
                                            üîÑ Actualizar Contrase√±a
                                        </button>
                                        <a href="{% url 'lista_calificaciones' %}" class="btn btn-secondary">
                                            ‚Üê Volver al Inicio
                                        </a>
                                    </div>
                                </form>
                                </div>

                                <div class="col-md-6">
                                    <div class="alert alert-info"
                                        style="background-color: #2a2a2a; border: 1px solid #444; color: #ffffff;">
                                        <h6 style="color: #ff4201; margin-bottom: 15px;">üìù Requisitos de contrase√±a:</h6>
                                        <ul class="mb-0" style="padding-left: 6px;">
                                            <li id="pw-rule-not-similar" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> No puede ser similar a tu informaci√≥n personal</li>
                                            <li id="pw-rule-length" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> Debe contener al menos 8 caracteres</li>
                                            <li id="pw-rule-not-common" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> No puede ser una contrase√±a com√∫n</li>
                                            <li id="pw-rule-not-numeric" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> No puede ser completamente num√©rica</li>
                                            <li id="pw-rule-upper" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> Contener al menos 1 letra may√∫scula</li>
                                            <li id="pw-rule-lower" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> Contener al menos 1 letra min√∫scula</li>
                                            <li id="pw-rule-digit" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> Contener al menos 1 d√≠gito</li>
                                            <li id="pw-rule-special" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> Contener al menos 1 s√≠mbolo (ej. !@#$%)</li>
                                            <li id="pw-rule-match" class="pw-rule invalid"> <span class="rule-icon">‚úñ</span> La confirmaci√≥n debe coincidir</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- Secci√≥n MFA -->
                            <div>
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h5 class="mb-4"
                                            style="color: #ff4201; border-bottom: 2px solid #ff4201; padding-bottom: 10px;">
                                            üîê Autenticaci√≥n de Dos Factores (MFA)
                                        </h5>

                                        <div class="card">
                                            <div class="card-body" style="background-color: #2a2a2a;">
                                                <div class="row align-items-center">
                                                    <div class="col-md-8">
                                                        <h6 style="color: #ffffff;">Estado MFA/2FA</h6>
                                                        <p class="mb-0" style="color: #cccccc;">
                                                            {% if mfa_enabled %}
                                                            <span class="badge bg-success">‚úÖ Activado</span>
                                                            - Tu cuenta est√° protegida con autenticaci√≥n de dos factores
                                                            {% else %}
                                                            <span class="badge bg-warning">‚ö†Ô∏è No Activado</span>
                                                            - A√±ade una capa extra de seguridad a tu cuenta
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <div class="col-md-4 text-end">
                                                        {% if mfa_enabled %}
                                                        <form method="post" action="{% url 'mfa_disable' %}"
                                                            onsubmit="return confirm('¬øEst√°s seguro de que quieres desactivar MFA? Esto reduce la seguridad de tu cuenta.');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                                üö´ Desactivar MFA
                                                            </button>
                                                        </form>
                                                        {% else %}
                                                        <a href="{% url 'mfa_setup' %}" class="btn btn-primary btn-sm">
                                                            ‚öôÔ∏è Configurar MFA
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                {% if not mfa_enabled %}
                                                <div class="mt-3 alert alert-info">
                                                    <small style="color: #ffffff;">
                                                        <strong>üí° Recomendaci√≥n de seguridad:</strong>
                                                        Activa MFA para proteger tu cuenta con Google Authenticator.
                                                        Requerir√°s tu contrase√±a y un c√≥digo temporal para ingresar.
                                                    </small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para el perfil */
    .profile-info-item {
        padding: 12px 15px;
        background-color: #2a2a2a;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #ff4201;
    }

    .password-field {
        color: #ffffff !important;
        background-color: #2a2a2a !important;
        border: 1px solid #444 !important;
        padding: 12px 15px;
        border-radius: 5px;
    }

    .password-field:focus {
        border-color: #ff4201 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 66, 1, 0.25) !important;
        background-color: #2a2a2a !important;
        color: #ffffff !important;
    }

    .password-field::placeholder {
        color: #888888 !important;
        opacity: 1;
    }

    .form-label {
        color: #ffffff !important;
        font-weight: 500;
        margin-bottom: 8px;
    }

    /* Botones */
    .btn-primary {
        background-color: #ff4201;
        border-color: #ff4201;
        color: #000000;
        font-weight: bold;
        padding: 12px 24px;
    }

    .btn-primary:hover {
        background-color: #e03a01;
        border-color: #e03a01;
        color: #000000;
    }

    .btn-secondary {
        background-color: #666666;
        border-color: #666666;
        color: #ffffff;
        font-weight: bold;
        padding: 12px 24px;
    }

    .btn-secondary:hover {
        background-color: #555555;
        border-color: #555555;
        color: #ffffff;
    }

    /* Alertas */
    .alert {
        border-radius: 8px;
        border: none;
        padding: 20px;
    }

    .alert-danger {
        background-color: #dc3545;
        color: #ffffff;
    }

    .alert-info {
        background-color: #2a2a2a;
        border: 1px solid #444;
        color: #ffffff;
    }

    /* Reglas de contrase√±a (indicadores) */
    .pw-rule {
        margin-bottom: 8px;
        color: #cccccc;
        display: flex;
        gap: 8px;
        align-items: flex-start;
    }

    .pw-rule .rule-icon {
        width: 20px;
        display: inline-block;
        color: #888888;
        font-weight: bold;
    }

    .pw-rule.valid {
        color: #bff1c9;
    }

    .pw-rule.valid .rule-icon {
        color: #4CAF50;
    }

    .pw-rule.invalid .rule-icon {
        color: #bbbbbb;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .profile-avatar {
            margin-bottom: 30px;
        }

        .d-flex.gap-2 {
            flex-direction: column;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>

<script>
    // JavaScript para mejorar la experiencia de usuario
    document.addEventListener('DOMContentLoaded', function () {
        // Agregar placeholders si no est√°n presentes
        const passwordFields = document.querySelectorAll('.password-field');
        const placeholders = [
            'Ingresa tu contrase√±a actual',
            'Ingresa nueva contrase√±a',
            'Confirma nueva contrase√±a'
        ];

        passwordFields.forEach((field, index) => {
            if (!field.getAttribute('placeholder')) {
                field.setAttribute('placeholder', placeholders[index]);
            }
        });

        // Mostrar/ocultar contrase√±as (opcional)
        const togglePassword = document.createElement('button');
        togglePassword.type = 'button';
        togglePassword.innerHTML = 'üëÅÔ∏è';
        togglePassword.style.background = 'none';
        togglePassword.style.border = 'none';
        togglePassword.style.color = '#ff4201';
        togglePassword.style.cursor = 'pointer';
        togglePassword.style.marginLeft = '10px';

        // Puedes agregar funcionalidad para mostrar/ocultar contrase√±a aqu√≠

        // --- Validaci√≥n en vivo para cambio de contrase√±a ---
        const newPwd = document.getElementById('id_new_password1');
        const confirmPwd = document.getElementById('id_new_password2');
        const oldPwd = document.getElementById('id_old_password');
        const submitBtn = document.getElementById('change-password-submit');

        const rules = {
            length: document.getElementById('pw-rule-length'),
            upper: document.getElementById('pw-rule-upper'),
            lower: document.getElementById('pw-rule-lower'),
            digit: document.getElementById('pw-rule-digit'),
            special: document.getElementById('pw-rule-special'),
            notSimilar: document.getElementById('pw-rule-not-similar'),
            notNumeric: document.getElementById('pw-rule-not-numeric'),
            notCommon: document.getElementById('pw-rule-not-common'),
            match: document.getElementById('pw-rule-match')
        };

        const commonPasswords = ['123456','password','12345678','qwerty','abc123','password1','admin','123456789'];

        const userName = "{{ user.nombre|default:''|escapejs }}".toLowerCase();
        const userEmail = "{{ user.correo|default:''|escapejs }}".toLowerCase();
        const emailLocal = userEmail.split('@')[0] || '';

        function setRuleState(el, ok) {
            if (!el) return;
            if (ok) {
                el.classList.remove('invalid');
                el.classList.add('valid');
                el.querySelector('.rule-icon').textContent = '‚úî';
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                el.querySelector('.rule-icon').textContent = '‚úñ';
            }
        }

        function validateAll() {
            const p = newPwd.value || '';
            const pLower = p.toLowerCase();
            const confirmed = (confirmPwd.value || '');

            setRuleState(rules.length, p.length >= 8);
            setRuleState(rules.upper, /[A-Z]/.test(p));
            setRuleState(rules.lower, /[a-z]/.test(p));
            setRuleState(rules.digit, /[0-9]/.test(p));
            setRuleState(rules.special, /[^A-Za-z0-9]/.test(p));
            setRuleState(rules.notNumeric, !/^\d+$/.test(p));
            setRuleState(rules.notCommon, !commonPasswords.includes(pLower));

            const similar = (userName && pLower.includes(userName.split(' ')[0])) || (emailLocal && pLower.includes(emailLocal));
            setRuleState(rules.notSimilar, !similar);

            setRuleState(rules.match, p.length > 0 && p === confirmed);

            // habilitar submit s√≥lo si todas las reglas cr√≠ticas cumplen y hay contrase√±a actual
            const allOk = [rules.length, rules.upper, rules.lower, rules.digit, rules.special, rules.notNumeric, rules.notCommon, rules.notSimilar, rules.match].every(r => r && r.classList.contains('valid'));
            submitBtn.disabled = !(allOk && (oldPwd.value || '').length > 0);
        }

        [newPwd, confirmPwd, oldPwd].forEach(el => {
            if (!el) return;
            el.addEventListener('input', validateAll);
        });

        // Ejecutar una vez al cargar
        validateAll();
    });
</script>
{% endblock %}