{% extends 'calificaciones/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">üì§ Carga Masiva de Calificaciones</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>üí° Informaci√≥n sobre Carga Masiva</h5>
                    <p class="mb-2">
                        Puede cargar calificaciones tributarias desde un archivo Excel o CSV. 
                        <strong>Si usa CSV y tiene problemas de encoding, guarde el archivo como UTF-8.</strong>
                    </p>
                    <p class="mb-0">
                        <strong>Formatos soportados:</strong> .csv (UTF-8, Latin-1), .xlsx, .xls
                    </p>
                </div>

                <!-- Informaci√≥n de formato mejorada -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">üìã Estructura del Archivo</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Nota sobre encoding:</strong> Si su archivo CSV tiene caracteres especiales (√±, √°, √©, √≠, √≥, √∫), 
                            gu√°rdelo como <strong>UTF-8</strong> o use la plantilla proporcionada.
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Campo</th>
                                        <th>Tipo</th>
                                        <th>Obligatorio</th>
                                        <th>Ejemplo</th>
                                        <th>Notas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Ejercicio</strong></td>
                                        <td>N√∫mero (4 d√≠gitos)</td>
                                        <td>‚úÖ S√≠</td>
                                        <td>2024</td>
                                        <td>A√±o comercial</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Mercado</strong></td>
                                        <td>Texto (3 caracteres)</td>
                                        <td>‚úÖ S√≠</td>
                                        <td>ACN</td>
                                        <td>ACN, CFI, Fondos_Mutuos</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Instrumento</strong></td>
                                        <td>Texto (50 caracteres)</td>
                                        <td>‚úÖ S√≠</td>
                                        <td>COPEC</td>
                                        <td>Nombre del instrumento</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Fecha</strong></td>
                                        <td>Fecha</td>
                                        <td>‚úÖ S√≠</td>
                                        <td>2024-01-15</td>
                                        <td>YYYY-MM-DD, DD/MM/YYYY o DD-MM-YYYY</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Secuencia</strong></td>
                                        <td>N√∫mero (>10000)</td>
                                        <td>‚úÖ S√≠</td>
                                        <td>10001</td>
                                        <td>Debe ser √∫nico por instrumento</td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-center bg-light">
                                            <strong>Factores 8 al 37 (Decimales con 8 decimales)</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Factor_8 a Factor_37</td>
                                        <td>Decimal (1.8)</td>
                                        <td>‚ùå Opcional</td>
                                        <td>0.12345678 o 0,12345678</td>
                                        <td>Usar punto o coma como separador decimal</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <a href="#" class="btn btn-sm btn-outline-primary" id="descargarPlantilla">
                                üì• Descargar Plantilla CSV (UTF-8)
                            </a>
                            <small class="text-muted ms-2">
                                (Use esta plantilla para asegurar el formato correcto y encoding UTF-8)
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Formulario de carga -->
                <form method="post" enctype="multipart/form-data" id="formCargaMasiva">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Errores en el formulario:</strong>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.tipo_carga.id_for_label }}" class="form-label">
                                    {{ form.tipo_carga.label }} *
                                </label>
                                {{ form.tipo_carga }}
                                <div class="form-text">Seleccione el tipo de datos que contiene el archivo</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.archivo.id_for_label }}" class="form-label">
                                    {{ form.archivo.label }} *
                                </label>
                                {{ form.archivo }}
                                {% if form.archivo.help_text %}
                                    <div class="form-text">{{ form.archivo.help_text }}</div>
                                {% endif %}
                                <div class="form-text text-warning">
                                    <strong>Problemas con CSV?</strong> Use la plantilla o convierta a Excel.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check">
                            {{ form.sobrescribir }}
                            <label class="form-check-label" for="{{ form.sobrescribir.id_for_label }}">
                                {{ form.sobrescribir.label }}
                            </label>
                            {% if form.sobrescribir.help_text %}
                                <div class="form-text">{{ form.sobrescribir.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Vista previa del archivo -->
                    <div class="card mb-4" id="vistaPrevia" style="display: none;">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">üëÅÔ∏è Vista Previa del Archivo (primeras 5 filas)</h6>
                        </div>
                        <div class="card-body">
                            <div id="contenidoVistaPrevia" class="table-responsive">
                                <!-- Aqu√≠ se cargar√° la vista previa -->
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'lista_calificaciones' %}" class="btn btn-secondary">
                            ‚Üê Volver al Listado
                        </a>
                        <button type="submit" class="btn btn-success" id="btnProcesar">
                            ‚ö° Procesar Carga Masiva
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const archivoInput = document.getElementById('{{ form.archivo.id_for_label }}');
    const vistaPrevia = document.getElementById('vistaPrevia');
    const contenidoVistaPrevia = document.getElementById('contenidoVistaPrevia');
    const btnProcesar = document.getElementById('btnProcesar');
    const formCargaMasiva = document.getElementById('formCargaMasiva');
    
    // Vista previa del archivo (para CSV)
    archivoInput.addEventListener('change', function(e) {
        const archivo = e.target.files[0];
        if (!archivo) return;
        
        if (archivo.name.endsWith('.csv')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const contenido = e.target.result;
                    const lineas = contenido.split('\n').slice(0, 6); // Mostrar primeras 5 l√≠neas
                    
                    let html = '<table class="table table-sm table-bordered">';
                    lineas.forEach((linea, index) => {
                        // Manejar diferentes separadores
                        const celdas = linea.split(',').length > 1 ? linea.split(',') : linea.split(';');
                        html += '<tr>';
                        celdas.forEach(celda => {
                            const celdaLimpia = celda.trim().replace(/"/g, '');
                            if (index === 0) {
                                html += `<th>${celdaLimpia}</th>`;
                            } else {
                                html += `<td>${celdaLimpia}</td>`;
                            }
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    if (lineas.length > 1) {
                        contenidoVistaPrevia.innerHTML = html;
                        vistaPrevia.style.display = 'block';
                    }
                } catch (error) {
                    contenidoVistaPrevia.innerHTML = '<p class="text-danger">Error al leer el archivo. Posible problema de encoding.</p>';
                    vistaPrevia.style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                contenidoVistaPrevia.innerHTML = '<p class="text-danger">Error al leer el archivo. Intente guardarlo como UTF-8.</p>';
                vistaPrevia.style.display = 'block';
            };
            
            // Leer como texto para manejar diferentes encodings
            reader.readAsText(archivo);
        } else {
            vistaPrevia.style.display = 'none';
        }
    });
    
    // Descargar plantilla UTF-8
    document.getElementById('descargarPlantilla').addEventListener('click', function(e) {
        e.preventDefault();
        
        const csvContent = "Ejercicio,Mercado,Instrumento,Fecha,Secuencia,Numero_dividendo,Descripcion,Tipo_sociedad,Valor_Historico,Acogido_ISFUT,Factor_actualizacion,Factor_8,Factor_9,Factor_10\n2024,ACN,COPEC,2024-01-15,10001,0,Dividendo ordinario,A,1000.00,false,0.00000000,0.10000000,0.05000000,0.00000000";
        
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'plantilla_calificaciones_utf8.csv');
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    // Confirmaci√≥n antes de procesar
    formCargaMasiva.addEventListener('submit', function(e) {
        const archivo = archivoInput.files[0];
        if (!archivo) {
            e.preventDefault();
            alert('Por favor seleccione un archivo para cargar.');
            return;
        }
        
        btnProcesar.innerHTML = '‚è≥ Procesando...';
        btnProcesar.disabled = true;
    });
});
</script>
{% endblock %}